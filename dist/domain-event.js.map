{"version":3,"file":"domain-event.js","sourceRoot":"","sources":["../src/domain-event.ts"],"names":[],"mappings":"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","sourcesContent":["import { AggregateState } from \"./aggregate-state\";\nimport { given } from \"@nivinjoseph/n-defensive\";\nimport { DomainEventData } from \"./domain-event-data\";\nimport \"@nivinjoseph/n-ext\";\nimport { DomainHelper, AggregateRoot } from \".\";\nimport { DomainContext } from \"./domain-context\";\nimport { ApplicationException } from \"@nivinjoseph/n-exception\";\n\n// public\nexport abstract class DomainEvent<T extends AggregateState>\n{\n    private _aggregateId: string | null;\n    private readonly _id: string;\n    private _user: string | null; // who\n    private readonly _name: string; // what\n    private readonly _occurredAt: number; // when\n    private _version: number;\n    private readonly _isCreatedEvent: boolean;\n\n\n    public get aggregateId(): string | null { return this._aggregateId; }\n    public get id(): string { return this._id; }\n    public get user(): string | null { return this._user; }\n    public get name(): string { return this._name; }\n    public get occurredAt(): number { return this._occurredAt; }\n    public get version(): number { return this._version; }\n    public get isCreatedEvent(): boolean { return this._isCreatedEvent; }\n\n    // occurredAt is epoch milliseconds\n    // public constructor(user: string, occurredAt: number = DomainHelper.now, version: number = 0)\n    public constructor(data: DomainEventData)\n    {\n        given(data, \"data\").ensureHasValue()\n            .ensureHasStructure({\n                \"$aggregateId?\": \"string\",\n                \"$id?\": \"string\",\n                \"$user?\": \"string\",\n                \"$name?\": \"string\",\n                \"$occurredAt?\": \"number\",\n                \"$version?\": \"number\",\n                \"$isCreatedEvent?\": \"boolean\"\n            });\n\n        this._aggregateId = data.$aggregateId || null;\n        this._id = data.$id || DomainHelper.generateId();\n        this._user = data.$user && !data.$user.isEmptyOrWhiteSpace() ? data.$user.trim() : null;\n        this._name = (<Object>this).getTypeName();\n        this._occurredAt = data.$occurredAt || DomainHelper.now;\n        this._version = data.$version || 0;\n        this._isCreatedEvent = !!data.$isCreatedEvent;\n    }\n\n\n    public apply(aggregate: AggregateRoot<T>, domainContext: DomainContext, state: T): void\n    {\n        given(aggregate, \"aggregate\").ensureHasValue().ensureIsObject().ensure(t => t instanceof AggregateRoot);\n        given(domainContext, \"domainContext\").ensureHasValue().ensureHasStructure({ user: \"string\" });\n        given(state, \"state\").ensureHasValue().ensureIsObject();\n\n        if (this._user == null)\n            this._user = domainContext.user;\n        \n        this._version = state.version || 0; // the version of the state before the application of the event => becomes the version of the event\n\n        this.applyEvent(state as T);\n\n        if (this._aggregateId != null && this._aggregateId !== aggregate.id)\n            throw new ApplicationException(`Event of type '${this._name}' with id ${this._id} and aggregateId '${this._aggregateId}' is being applied on Aggregate of type '${(<Object>aggregate).getTypeName()}' with id '${aggregate.id}'`);\n\n        this._aggregateId = aggregate.id;\n        state.version = this._version + 1;\n    }\n\n    public serialize(): DomainEventData\n    {\n        return Object.assign(this.serializeEvent(), {\n            $aggregateId: this._aggregateId,\n            $id: this._id,\n            $user: this._user,\n            $name: this._name,\n            $occurredAt: this._occurredAt,\n            $version: this._version,\n            $isCreatedEvent: this._isCreatedEvent\n        });\n    }\n\n\n    protected abstract serializeEvent(): object;\n    protected abstract applyEvent(state: T): void;\n}"]}